name: KnowHowIA - store case on merge (android repo)

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

jobs:
  debug:
    name: debug-conditions
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "merged: ${{ github.event.pull_request.merged }}"
          echo "pr_number: ${{ github.event.pull_request.number }}"
          echo "pr_url: ${{ github.event.pull_request.html_url }}"
          echo "labels: ${{ join(github.event.pull_request.labels.*.name, ',') }}"
          echo "base_sha: ${{ github.event.pull_request.base.sha }}"
          echo "merge_sha(github.sha): ${{ github.sha }}"

  store:
    name: generate-and-commit-cases
    needs: debug
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout do repo ANDROID (onde o PR foi mergeado)
      - name: Checkout Android repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Buscar PR body via API e extrair crash + preparar pr.txt com diff
      - name: Build crash.txt and pr.txt from PR (via API + git diff)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          MERGE_SHA: ${{ github.sha }}
        run: |
          python3 - << 'PY'
          import os, re, json, sys, urllib.request

          token = os.environ["GH_TOKEN"]
          repo = os.environ["REPO"]
          pr_number = os.environ["PR_NUMBER"]

          url = f"https://api.github.com/repos/{repo}/pulls/{pr_number}"
          req = urllib.request.Request(url)
          req.add_header("Authorization", f"Bearer {token}")
          req.add_header("Accept", "application/vnd.github+json")

          with urllib.request.urlopen(req) as resp:
              data = json.loads(resp.read().decode("utf-8"))

          body = data.get("body") or ""
          m = re.search(r"```text\s*(.*?)\s*```", body, re.S)
          if not m:
              print("Sem bloco ```text``` no PR. Não é PR de crash -> não vou gerar case.")
              open(".__knowhowia_skip__", "w", encoding="utf-8").write("skip\n")
              sys.exit(0)

          crash = m.group(1).strip()
          if len(crash) < 80:
              print("Bloco de crash muito curto. Não vou gerar case.")
              open(".__knowhowia_skip__", "w", encoding="utf-8").write("skip\n")
              sys.exit(0)

          open("crash.txt","w",encoding="utf-8").write(crash + "\n")
          print("OK: crash.txt criado.")
          PY

          if [ -f .__knowhowia_skip__ ]; then
            echo "SKIP: PR sem crash block válido."
            exit 0
          fi

          {
            echo "Title:"
            echo "${PR_TITLE}"
            echo ""
            echo "PR URL:"
            echo "${PR_URL}"
            echo ""
            echo "Diff (base..merge):"
            echo ""
            git diff "${BASE_SHA}" "${MERGE_SHA}"
          } > pr.txt

      - name: Stop if no crash block
        if: ${{ hashFiles('.__knowhowia_skip__') != '' }}
        run: |
          echo "Encerrando: PR não tinha crash block válido."
          exit 0

      # 3) Checkout do repo KnowHowIA (tool Kotlin/JVM) dentro de uma subpasta
      - name: Checkout KnowHowIA tool repo
        uses: actions/checkout@v4
        with:
          repository: zuperboni/knowhowia
          ref: master
          path: knowhowia-tool
          fetch-depth: 1

      # 4) Copiar inputs dentro do tool repo
      - name: Copy inputs to tool repo
        run: |
          cp crash.txt knowhowia-tool/crash.txt
          cp pr.txt knowhowia-tool/pr.txt

      # 5) Rodar analyze no repo KnowHowIA
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable (tool repo)
        run: chmod +x knowhowia-tool/gradlew

      - name: Verify OPENAI_API_KEY is present (android repo secrets)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "ERRO: secrets.OPENAI_API_KEY vazio/não configurado no repo Android."
            exit 1
          fi

      - name: Run KnowHowIA analyze (tool repo)
        working-directory: knowhowia-tool
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          ./gradlew run --args="analyze"

      # 6) Copiar o resultado pro repo Android e commitar
      - name: Store cases in Android repo
        run: |
          mkdir -p knowhowia/cases knowhowia/cases_min

          # tool repo gera diretamente nesses diretórios
          if [ -d knowhowia-tool/cases ]; then
            cp -r knowhowia-tool/cases/* knowhowia/cases/
          else
            echo "ERRO: knowhowia-tool/cases não existe. Verifique o tool repo."
            exit 1
          fi

          if [ -d knowhowia-tool/cases_min ]; then
            cp -r knowhowia-tool/cases_min/* knowhowia/cases_min/
          else
            echo "ERRO: knowhowia-tool/cases_min não existe. Verifique o tool repo."
            exit 1
          fi

      - name: Commit stored cases (Android repo)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add knowhowia/cases/ knowhowia/cases_min/ || true

          if git diff --cached --quiet; then
            echo "Sem novos cases para commitar."
            exit 0
          fi

          git commit -m "chore(knowhowia): store case for PR #${{ github.event.pull_request.number }}"
          git push
