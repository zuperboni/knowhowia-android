name: KnowHowIA - store case on merge

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

jobs:
  debug:
    name: debug-conditions
    runs-on: ubuntu-latest
    steps:
      - name: Print merge + labels context
        run: |
          echo "merged: ${{ github.event.pull_request.merged }}"
          echo "pr_number: ${{ github.event.pull_request.number }}"
          echo "pr_title: ${{ github.event.pull_request.title }}"
          echo "pr_url: ${{ github.event.pull_request.html_url }}"
          echo "labels: ${{ join(github.event.pull_request.labels.*.name, ',') }}"
          echo "base_sha: ${{ github.event.pull_request.base.sha }}"
          echo "merge_sha(github.sha): ${{ github.sha }}"

  store:
    name: generate-and-commit-cases
    needs: debug
    if: >
      github.event.pull_request.merged == true &&
      contains(join(github.event.pull_request.labels.*.name, ','), 'knowhowia')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (merge commit)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Extract crash block -> crash.txt
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          python3 - << 'PY'
          import os, re, sys

          body = os.environ.get("PR_BODY") or ""
          m = re.search(r"```text\s*(.*?)\s*```", body, re.S)

          if not m:
              print("ERRO: não encontrei bloco ```text``` no corpo do PR.")
              print("Cole o stacktrace dentro de um bloco exatamente assim:")
              print("```text")
              print("<stacktrace>")
              print("```")
              sys.exit(1)

          crash = m.group(1).strip()
          if len(crash) < 80:
              print("ERRO: bloco ```text``` muito curto para ser stacktrace válido.")
              sys.exit(1)

          open("crash.txt", "w", encoding="utf-8").write(crash + "\n")
          print("OK: crash.txt gerado.")
          PY

      - name: Build pr.txt from PR metadata + diff
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          MERGE_SHA: ${{ github.sha }}
        run: |
          {
            echo "Title:"
            echo "$PR_TITLE"
            echo ""
            echo "PR URL:"
            echo "$PR_URL"
            echo ""
            echo "PR Number:"
            echo "$PR_NUMBER"
            echo ""
            echo "Diff (base..merge):"
            echo ""
            git diff "$BASE_SHA" "$MERGE_SHA"
          } > pr.txt

      - name: Run KnowHowIA analyze (generates cases)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          ./gradlew run --args="analyze"

      - name: Commit generated cases
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # só versiona a base
          git add cases/ cases_min/ || true

          if git diff --cached --quiet; then
            echo "Sem novos cases para commitar."
            exit 0
          fi

          git commit -m "chore(knowhowia): store case for PR #${{ github.event.pull_request.number }}"
          git push
