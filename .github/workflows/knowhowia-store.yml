name: KnowHowIA - store case on merge

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: read

jobs:
  debug:
    name: debug-conditions
    runs-on: ubuntu-latest
    steps:
      - name: Print merge + labels context
        run: |
          echo "merged: ${{ github.event.pull_request.merged }}"
          echo "pr_number: ${{ github.event.pull_request.number }}"
          echo "pr_title: ${{ github.event.pull_request.title }}"
          echo "pr_url: ${{ github.event.pull_request.html_url }}"
          echo "labels: ${{ join(github.event.pull_request.labels.*.name, ',') }}"
          echo "base_sha: ${{ github.event.pull_request.base.sha }}"
          echo "merge_sha(github.sha): ${{ github.sha }}"

  store:
    name: generate-and-commit-cases
    needs: debug
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Fetch PR body and decide if it has crash block
        id: gate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python3 - << 'PY'
          import os, re, json, urllib.request

          token = os.environ["GH_TOKEN"]
          repo = os.environ["REPO"]
          pr_number = os.environ["PR_NUMBER"]

          url = f"https://api.github.com/repos/{repo}/pulls/{pr_number}"
          req = urllib.request.Request(url)
          req.add_header("Authorization", f"Bearer {token}")
          req.add_header("Accept", "application/vnd.github+json")

          with urllib.request.urlopen(req) as resp:
              data = json.loads(resp.read().decode("utf-8"))

          body = data.get("body") or ""
          has = bool(re.search(r"```text\s*(.*?)\s*```", body, re.S))

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write(f"has_crash_block={str(has).lower()}\n")

          if has:
              print("OK: PR possui bloco ```text``` (crash). Vou gerar case.")
          else:
              print("Sem bloco ```text``` no PR body. Não é PR de crash -> não vou gerar case.")
          PY

      - name: Stop if no crash block
        if: steps.gate.outputs.has_crash_block != 'true'
        run: |
          echo "Encerrando: PR sem crash block."
          exit 0

      - name: Checkout (merge commit)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Extract crash block -> crash.txt (via API)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python3 - << 'PY'
          import os, re, json, urllib.request, sys

          token = os.environ["GH_TOKEN"]
          repo = os.environ["REPO"]
          pr_number = os.environ["PR_NUMBER"]

          url = f"https://api.github.com/repos/{repo}/pulls/{pr_number}"
          req = urllib.request.Request(url)
          req.add_header("Authorization", f"Bearer {token}")
          req.add_header("Accept", "application/vnd.github+json")

          with urllib.request.urlopen(req) as resp:
              data = json.loads(resp.read().decode("utf-8"))

          body = data.get("body") or ""
          m = re.search(r"```text\s*(.*?)\s*```", body, re.S)
          if not m:
              print("ERRO: não encontrei bloco ```text``` no corpo do PR.")
              sys.exit(1)

          crash = m.group(1).strip()
          if len(crash) < 80:
              print("ERRO: bloco ```text``` muito curto para ser stacktrace válido.")
              sys.exit(1)

          open("crash.txt", "w", encoding="utf-8").write(crash + "\n")
          print("OK: crash.txt gerado.")
          PY

      - name: Build pr.txt from PR metadata + diff
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          MERGE_SHA: ${{ github.sha }}
        run: |
          {
            echo "Title:"
            echo "$PR_TITLE"
            echo ""
            echo "PR URL:"
            echo "$PR_URL"
            echo ""
            echo "PR Number:"
            echo "$PR_NUMBER"
            echo ""
            echo "Diff (base..merge):"
            echo ""
            git diff "$BASE_SHA" "$MERGE_SHA"
          } > pr.txt

      - name: Verify OPENAI_API_KEY is present
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "ERRO: secrets.OPENAI_API_KEY está vazio ou não configurado."
            echo "Configure em Settings → Secrets and variables → Actions → OPENAI_API_KEY"
            exit 1
          fi

      - name: Run KnowHowIA analyze (generates cases)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          ./gradlew run --args="analyze"

      - name: Commit generated cases
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add cases/ cases_min/ || true

          if git diff --cached --quiet; then
            echo "Sem novos cases para commitar."
            exit 0
          fi

          git commit -m "chore(knowhowia): store case for PR #${{ github.event.pull_request.number }}"
          git push
